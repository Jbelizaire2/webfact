{% extends 'Main/base_test.html.twig' %}


{% block body %}

           <div class="box box-primary">
            <div class="box-header with-border">
              <h3 class="box-title">CREAR USUARIO</h3>
            </div>

		<div class="box-body">
    		<div class="form-group">
    			
    			
    			
    				<div style="text-align: right">
    					<a href="{{ path('mantenedor_user_index') }}" class="btn btn-success" >Volver a lista</a>
        			</div>
    					
    		</div>
    		<br>
		<div class="col-lg-12 well">
			<form id="formUser" action="{{ path('mantenedor_user_save') }}" method="POST">
				<div class="form-row align-items-center">
					<legend>Datos Personales</legend>
					<div class="col-lg-6">
						<div class="form-group">
							<label for="rutPersona">Rut</label>
							<input type="text" class="form-control" name="rutPersona" id="rutPersona" maxlength="12" required autocomplete="off">
						</div>
						<div class="form-group">
							<label for="apellidoPersona">Apellido</label>
							<input type="text" class="form-control" name="apellidoPersona" id="apellidoPersona" disabled required>
						</div>
						<div class="form-group">
							<label for="correoPersona">Correo</label>
							<input type="email" class="form-control" name="correoPersona" id="correoPersona" disabled>
						</div>
					</div>
					<div class="col-lg-6">
						<div class="form-group">
							<label for="nombrePersona">Nombre</label>
							<input type="text" class="form-control" name="nombrePersona" id="nombrePersona" disabled required>
						</div>
						<div class="form-group">
							<label for="sexoPersona">Sexo</label>
							<select class="form-control" name="sexoPersona" id="sexoPersona" disabled required>
								<option value="0" selected>Seleccione</option>
								<option value="m">Masculino</option>
								<option value="f">Femenino</option>
							</select>
						</div>
						<div class="form-group">
							<label for="phonePersona">Teléfono</label>
							<input type="number" class="form-control" id="phonePersona" name="phonePersona" disabled>
						</div>
					</div>
				</div>
				<div class="form-row align-items-center">
					<legend>Datos de Perfil</legend>
					<div class="col-lg-6">
						<div class="form-group">
							<label for="username">Usuario</label>
							<input type="text" class="form-control" name="username" id="username" disabled required>
						</div>
						<div class="form-group">
							<label for="password">Contraseña</label>
							<input type="password" class="form-control" name="password" id="password" disabled required>
						</div>
					</div>
					<div class="col-sm-3 my-1">
						<div class="form-group">
							<label for="rol">Rol</label>
							<select class="form-control custom" name="rol" id="rol" disabled required multiple>
								{% for r in roles %}
									<option value="{{ r.id }}">{{ r.namePublic }}</option>
								{% endfor %}
							</select>
						</div>
						
					</div>
				</div>
				<div class="col-md-12">
					<div class="form-group">
						<div class="col-md-4">
							
						</div>
						<div class="col-md-4">
						</div>	
						<div class="col-md-4">
				<div style="text-align: right">
					<button type="submit" class="btn btn-success" id="btnCreateUser" disabled>Crear Usuario</button>
				</div>
						</div>			
					</div>
        
        </div>
			</form>
			
		</div>
		</div>
{% endblock %}
{% block javascripts %}
<script type="text/javascript">
	$(function() {
		$('.custom').select2();

		$('#formUser').on('submit', function(e){
			var rut        = $('#rutPersona').val();
			var rutPersona = $.Rut.quitarFormato(rut);
			$('#rutPersona').val(rutPersona);
			return true;
		});

		$('#rutPersona').Rut({
		  on_error: function(){
		  	disabledPerson(true);
		  	$.iGrowl({
	                title: 'Error',
	                message: 'Rut Incorrecto, Vuelva a ingresarlo!',
	                type: 'error-sat',
	                icon: 'steadysets-forbidden',
	                animShow: 'fadeInDown',
	                animHide: 'fadeOutRight',
	                placement : {
	                x:  'right',
	                y:  'top'
	                }
	            });
	        $('#rutPersona').focus() 
	      },
	      on_success: function(){
	      	var rut = $('#rutPersona').val();
	      	if (rut.length > 10) {
	      		var rutPersona = $.Rut.quitarFormato(rut);
	      		$.ajax({
	      			url: "user/find/"+rutPersona,

	      			dataType: "json",
	      			type: "POST"
	      		})
	      		.done(function(data) {
					  console.log(data);
	      			if (data.state == 500) {
	  				  	$.iGrowl({
			                title: 'Error',
			                message: 'Rut ya se encuentra Registrado',
			                type: 'error-sat',
			                icon: 'steadysets-forbidden',
			                animShow: 'fadeInDown',
			                animHide: 'fadeOutRight',
			                placement : {
			                x:  'right',
			                y:  'top'
			                }
			            });
	      			}else{
	      				disabledPerson(false);
	      				loadPerson(data.persona);
	      			}
	      		})
	      		.fail(function(data){
	      			disabledPerson(false);
	      		})
	      	}
	      },
		  format_on: 'keyup'
		})

		function disabledPerson($state){
			$('#nombrePersona').prop('disabled', $state);
			$('#apellidoPersona').prop('disabled', $state);
			$('#correoPersona').prop('disabled', $state);
			$('#sexoPersona').prop('disabled', $state);
			$('#phonePersona').prop('disabled', $state);
			$('#username').prop('disabled', $state);
			$('#password').prop('disabled', $state);
			$('#rol').prop('disabled', $state);
			$('#btnCreateUser').prop('disabled', $state);
		}

		function loadPerson(persona){
			var person = JSON.parse(persona);
			$('#nombrePersona').val(person.name);
			$('#apellidoPersona').val(person.last_name);
			$('#correoPersona').val(person.mail);
			$('#sexoPersona').val(person.gender);
			$('#phonePersona').val(person.phone);
		}
		
	});
</script>	
{% endblock %}